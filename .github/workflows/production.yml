name: Deploy Another-Go App to Server

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_PROCESS_TIMEOUT: 600

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: mbstring, bcmath, pdo, tokenizer, openssl, zip, unzip, gd, curl, xml, json
          coverage: none
          tools: composer:v2

      - name: Validate Composer
        run: composer validate --strict

      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer Dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Composer Dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader --no-progress --no-suggest

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install NPM Dependencies
        run: npm ci

      - name: Build Frontend Assets
        run: npm run build

      - name: Create Deployment Archive
        run: |
          echo "Creating deployment archive..."
          tar --exclude='.git' \
              --exclude='node_modules' \
              --exclude='.env' \
              --exclude='storage/logs/*' \
              --exclude='storage/framework/cache/*' \
              --exclude='storage/framework/sessions/*' \
              --exclude='storage/framework/views/*' \
              --exclude='bootstrap/cache/*' \
              -czf deployment.tar.gz .

      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 65002
          timeout: 30s
          script: |
            echo "âœ… SSH connection successful"
            echo "Server info: $(uname -a)"
            echo "PHP version: $(php -v | head -1)"

      - name: Prepare Server Directories
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 65002
          timeout: 60s
          script: |
            echo "Creating backup of current deployment..."
            if [ -d "/home/u404772588/domains/another-go.com" ]; then
              cp -r /home/u404772588/domains/another-go.com /home/u404772588/domains/another-go.com.backup.$(date +%Y%m%d_%H%M%S)
            fi
            
            echo "Preparing directories..."
            mkdir -p /home/u404772588/domains/another-go.com/storage/{app,framework,logs}
            mkdir -p /home/u404772588/domains/another-go.com/storage/framework/{cache,sessions,views}
            mkdir -p /home/u404772588/domains/another-go.com/bootstrap/cache
            mkdir -p /home/u404772588/domains/another-go.com/public_html

      - name: Upload Deployment Archive
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 65002
          source: "deployment.tar.gz"
          target: "/home/u404772588/"
          timeout: 120s

      - name: Extract and Setup Application
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 65002
          timeout: 300s
          script: |
            cd /home/u404772588/
            echo "Extracting application..."
            tar -xzf deployment.tar.gz -C domains/another-go.com/
            rm deployment.tar.gz
            
            echo "Moving public files..."
            cp -r /home/u404772588/domains/another-go.com/public/* /home/u404772588/domains/another-go.com/public_html/
            
            echo "Setting up permissions..."
            find /home/u404772588/domains/another-go.com/storage -type f -exec chmod 644 {} \;
            find /home/u404772588/domains/another-go.com/storage -type d -exec chmod 755 {} \;
            find /home/u404772588/domains/another-go.com/bootstrap/cache -type f -exec chmod 644 {} \;
            find /home/u404772588/domains/another-go.com/bootstrap/cache -type d -exec chmod 755 {} \;

      - name: Setup Environment Configuration
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 65002
          timeout: 120s
          script: |
            cd /home/u404772588/domains/another-go.com
            
            echo "Setting up environment file..."
            if [ ! -f .env ]; then
              echo "Creating production .env file..."
              cat > .env << 'EOF'
            APP_NAME="${{ secrets.APP_NAME || 'Another-Go' }}"
            APP_ENV=production
            APP_KEY=
            APP_DEBUG=false
            APP_URL=https://another-go.com
            
            LOG_CHANNEL=stack
            LOG_DEPRECATIONS_CHANNEL=null
            LOG_LEVEL=error
            
            DB_CONNECTION=mysql
            DB_HOST="${{ secrets.DB_HOST}}"
            DB_PORT="${{ secrets.DB_PORT}}"
            DB_DATABASE="${{ secrets.DB_DATABASE }}"
            DB_USERNAME="${{ secrets.DB_USERNAME }}"
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            
            BROADCAST_DRIVER=log
            CACHE_DRIVER=file
            FILESYSTEM_DISK=local
            QUEUE_CONNECTION=sync
            SESSION_DRIVER=file
            SESSION_LIFETIME=120
            
            MEMCACHED_HOST=127.0.0.1
            
            REDIS_HOST=127.0.0.1
            REDIS_PASSWORD=null
            REDIS_PORT=6379
            
            MAIL_MAILER="smtp"
            MAIL_HOST="smtp.hostinger.com"
            MAIL_PORT="465"
            MAIL_USERNAME="${{ secrets.MAIL_USERNAME }}"
            MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}"
            MAIL_ENCRYPTION="ssl"
            MAIL_FROM_ADDRESS="${{ secrets.MAIL_USERNAME }}"
            MAIL_FROM_NAME="Another-Go"
            
            AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID || '' }}"
            AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY || '' }}"
            AWS_DEFAULT_REGION="${{ secrets.AWS_DEFAULT_REGION || 'us-east-1' }}"
            AWS_BUCKET="${{ secrets.AWS_BUCKET || '' }}"
            AWS_USE_PATH_STYLE_ENDPOINT=false
            
            PUSHER_APP_ID="${{ secrets.PUSHER_APP_ID || '' }}"
            PUSHER_APP_KEY="${{ secrets.PUSHER_APP_KEY || '' }}"
            PUSHER_APP_SECRET="${{ secrets.PUSHER_APP_SECRET || '' }}"
            PUSHER_HOST="${{ secrets.PUSHER_HOST || '' }}"
            PUSHER_PORT="${{ secrets.PUSHER_PORT || '443' }}"
            PUSHER_SCHEME="${{ secrets.PUSHER_SCHEME || 'https' }}"
            PUSHER_APP_CLUSTER="${{ secrets.PUSHER_APP_CLUSTER || 'mt1' }}"
            
            VITE_PUSHER_APP_KEY="${{ secrets.PUSHER_APP_KEY || '' }}"
            VITE_PUSHER_HOST="${{ secrets.PUSHER_HOST || '' }}"
            VITE_PUSHER_PORT="${{ secrets.PUSHER_PORT || '443' }}"
            VITE_PUSHER_SCHEME="${{ secrets.PUSHER_SCHEME || 'https' }}"
            VITE_PUSHER_APP_CLUSTER="${{ secrets.PUSHER_APP_CLUSTER || 'mt1' }}"
            EOF
              echo "Created production .env file with secrets"
            else
              echo "Using existing .env file"
            fi
            
            echo "Generating application key..."
            php artisan key:generate --force
            
            echo "Clearing configuration cache..."
            php artisan config:clear

      - name: Database Connection Test and Setup
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 65002
          timeout: 180s
          script: |
            cd /home/u404772588/domains/another-go.com
            
            echo "Testing database connection..."
            php artisan tinker --execute="
            try {
                DB::connection()->getPdo();
                echo 'Database connection: SUCCESS';
            } catch (Exception \$e) {
                echo 'Database connection: FAILED - ' . \$e->getMessage();
                exit(1);
            }"
            
            echo "Checking if database exists and creating if needed..."
            php artisan tinker --execute="
            try {
                \$dbName = env('DB_DATABASE');
                DB::statement('CREATE DATABASE IF NOT EXISTS ' . \$dbName);
                echo 'Database check/creation: SUCCESS';
            } catch (Exception \$e) {
                echo 'Database creation: ' . \$e->getMessage();
            }"
            
            echo "Running database migrations..."
            php artisan migrate --force
            
            echo "Seeding database (if needed)..."
            php artisan db:seed --force || echo "No seeders found or seeding failed"
            
            echo "Updating roles and permissions..."
            php artisan app:update-roles-and-permissions || echo "Custom command not found"

      - name: Optimize Application Performance
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 65002
          timeout: 120s
          script: |
            cd /home/u404772588/domains/another-go.com
            
            echo "Optimizing application..."
            php artisan optimize
            php artisan storage:link || echo "Storage link already exists"
            
            echo "Clearing old caches..."
            php artisan cache:clear
            php artisan view:clear
            php artisan config:clear
            
            echo "Building fresh caches..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

      - name: Setup Frontend Assets
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 65002
          timeout: 60s
          script: |
            cd /home/u404772588/domains/another-go.com
            
            echo "Setting up frontend assets..."
            if [ -d "public/build" ]; then
              cp -r public/build public_html/
              echo "Copied build assets to public_html"
            fi
            
            if [ -f "public/build/.vite/manifest.json" ]; then
              mkdir -p public_html/build
              cp public/build/.vite/manifest.json public_html/build/manifest.json
              echo "Fixed Vite manifest path"
            fi
            
            echo "Copying static assets..."
            cp -r public/css public_html/ 2>/dev/null || echo "No CSS directory"
            cp -r public/js public_html/ 2>/dev/null || echo "No JS directory"
            cp -r public/images public_html/ 2>/dev/null || echo "No images directory"
            cp -r public/assets public_html/ 2>/dev/null || echo "No assets directory"

      - name: Final Deployment Checks
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 65002
          timeout: 60s
          script: |
            cd /home/u404772588/domains/another-go.com
            
            echo "Running final deployment checks..."
            
            echo "âœ… Checking Laravel installation..."
            php artisan --version
            
            echo "âœ… Checking database connection..."
            php artisan migrate:status || echo "âš ï¸  Database connection issue"
            
            echo "âœ… Checking storage permissions..."
            ls -la storage/
            
            echo "âœ… Checking public_html setup..."
            ls -la public_html/
            
            echo "âœ… Verifying key Laravel files..."
            [ -f "public_html/index.php" ] && echo "âœ“ index.php exists" || echo "âœ— index.php missing"
            [ -f ".env" ] && echo "âœ“ .env exists" || echo "âœ— .env missing"
            
            echo "ðŸš€ Deployment completed successfully!"
            echo "ðŸŒ Your application should now be live at: https://another-go.com"

      - name: Cleanup Old Backups
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 65002
          timeout: 30s
          script: |
            echo "Cleaning up old backups (keeping last 5)..."
            cd /home/u404772588/domains/
            ls -t another-go.com.backup.* 2>/dev/null | tail -n +6 | xargs rm -rf
            echo "Cleanup completed"
